class EventBus {
  constructor() {
    this.events = {};
  }

  on(event, handler) {
    (this.events[event] ||= []).push(handler);
  }

  emit(event, data) {
    (this.events[event] || []).forEach(h => h(data));
  }
}

const eventBus = new EventBus();

const Game = (() => {
  // Game Data
  const gameData = {
    gameTitle: "„Åß„Å¶„Åç„Åü„ÅÆ„ÄÅ„Å™„Å´Ôºü",
    subtitle: "„ÄúË¶ã„Å¶„ÄÅ„Åä„Åº„Åà„Å¶„ÄÅÈ†ÜÁï™„Å´„Çø„ÉÉ„Éó„Äú",
    emojis: {
      animals: ["üê∂", "üê±", "üê≠", "üê∞", "üêº", "üê∏", "üê∑", "üêò", "üêµ", "üê•"],
      foods: ["üçé", "üçå", "üçá", "üçì", "üçâ", "ü•ï", "üçû", "üçö", "üç©", "üç∞"],
      toys: ["üõù", "üéà", "üß©", "üé≤"],
      vehicles: ["üöó", "üöå", "üöì", "üöë", "üöí", "üö≤", "‚úàÔ∏è", "üö§"],
      items: ["üéí", "üõè", "üîë"]
    },
    gameSettings: {
      normalMode: {
        startLevel: 2,
        maxLevel: 10,
        displayDuration: 1000
      },
      hardMode: {
        startPairs: 2,
        maxPairs: 5,
        displayDuration: 1200
      }
    },
    colors: {
      primary: "#FF6B6B",
      accent: "#4ECDC4",
      background: "#F8F9FA",
      success: "#51CF66",
      error: "#FF6B6B"
    }
  };

  const GamePhases = {
    READY: 'ready',
    DISPLAYING: 'displaying',
    INPUT: 'input',
    RESULT: 'result'
  };

// Game State
  let currentGameState = {
    mode: null, // 'normal' or 'hard'
    level: 1,
    score: 0,
    sequence: [],
    userSequence: [],
    isPlaying: false,
    isDisplaying: false,
    combo: 0,
    maxCombo: 0,
    hasMistake: false,
    phase: GamePhases.READY,
    settings: {
      volume: 0.5,
      soundEnabled: true,
      displaySpeed: 'normal'
    }
  };

// „Éê„ÉÉ„Ç∏„Éá„Éº„Çø
  const badges = [
    { id: 'first_win', name: '„ÅØ„Åò„ÇÅ„Å¶„ÅÆ„Åõ„ÅÑ„Åì„ÅÜ', emoji: 'üéØ', description: '„ÅØ„Åò„ÇÅ„Å¶„É¨„Éô„É´„Çí„ÇØ„É™„Ç¢„Åó„Åü', unlocked: false },
    { id: 'level5', name: '„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ„Åõ„ÅÑ', emoji: 'üèÖ', description: '„É¨„Éô„É´5„Å´Âà∞ÈÅî„Åó„Åü', unlocked: false },
    { id: 'level10', name: '„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ„Åõ„ÅÑ', emoji: 'üèÜ', description: '„É¨„Éô„É´10„Å´Âà∞ÈÅî„Åó„Åü', unlocked: false },
    { id: 'combo10', name: '„Ç≥„É≥„Éú„Éû„Çπ„Çø„Éº', emoji: '‚ö°', description: '10„Ç≥„É≥„Éú„ÇíÈÅîÊàê„Åó„Åü', unlocked: false },
    { id: 'perfect', name: '„Éë„Éº„Éï„Çß„ÇØ„Éà', emoji: '‚ú®', description: '„Éü„Çπ„Å™„Åó„Åß„É¨„Éô„É´„Çí„ÇØ„É™„Ç¢„Åó„Åü', unlocked: false }
  ];

  // Audio Context
  let audioContext = null;
  let gainNode = null;

  // DOM Elements
  let elements = {};

// Initialize the application
function initializeApp() {
  console.log('DOM loaded, initializing game...');
  
  // Get all DOM elements
  initializeElements();
  
  // Set up event listeners
  setupEventListeners();
  
  // Initialize audio
  initializeAudio();
  
  // Load settings
  loadSettings();

  // Debug phase changes
  eventBus.on('phase', p => console.log('Phase changed:', p));
  
  // Show initial screen
  showScreen('top-screen');
  
  console.log('Game initialized successfully');
}

// Initialize DOM elements
  function initializeElements() {
    elements = {
    // Screens
    topScreen: document.getElementById('top-screen'),
    gameScreen: document.getElementById('game-screen'),
    settingsScreen: document.getElementById('settings-screen'),
    
    // Top screen buttons
    normalModeBtn: document.getElementById('normal-mode-btn'),
    hardModeBtn: document.getElementById('hard-mode-btn'),
    settingsBtn: document.getElementById('settings-btn'),
    tutorialBtn: document.getElementById('tutorial-btn'),
    
    // Game screen elements
    backToMenuBtn: document.getElementById('back-to-menu-btn'),
    currentLevel: document.getElementById('current-level'),
    currentScore: document.getElementById('current-score'),
    levelProgress: document.getElementById('level-progress'),
    emojiDisplaySingle: document.getElementById('emoji-display-single'),
    emojiDisplayDual: document.getElementById('emoji-display-dual'),
    gameStatus: document.getElementById('game-status'),
    statusText: document.getElementById('status-text'),
    choiceArea: document.getElementById('choice-area'),
    choiceGrid: document.getElementById('choice-grid'),
    startGameBtn: document.getElementById('start-game-btn'),
    nextLevelBtn: document.getElementById('next-level-btn'),
    replayBtn: document.getElementById('replay-btn'),
    hintBtn: document.getElementById('hint-btn'),
    
    // Settings screen elements
    backFromSettingsBtn: document.getElementById('back-from-settings-btn'),
    volumeSlider: document.getElementById('volume-slider'),
    volumeValue: document.getElementById('volume-value'),
    soundToggle: document.getElementById('sound-toggle'),
    displaySpeed: document.getElementById('display-speed'),
    resetScoresBtn: document.getElementById('reset-scores-btn'),
    
    // Modal elements
    resultModal: document.getElementById('result-modal'),
    resultEmoji: document.getElementById('result-emoji'),
    resultTitle: document.getElementById('result-title'),
    resultMessage: document.getElementById('result-message'),
    continueBtn: document.getElementById('continue-btn'),
    endGameBtn: document.getElementById('end-game-btn'),
    
    // Loading screen
    loadingScreen: document.getElementById('loading-screen')
  };
  
  console.log('DOM elements initialized');
}

// Set up all event listeners
function setupEventListeners() {
  console.log('Setting up event listeners...');
  
  // Top screen navigation
  elements.normalModeBtn.addEventListener('click', () => {
    console.log('Normal mode button clicked');
    startGame('normal');
  });
  
  elements.hardModeBtn.addEventListener('click', () => {
    console.log('Hard mode button clicked');
    startGame('hard');
  });
  
  elements.settingsBtn.addEventListener('click', () => {
    console.log('Settings button clicked');
    showScreen('settings-screen');
  });
  
  elements.tutorialBtn.addEventListener('click', () => {
    console.log('Tutorial button clicked');
    showTutorial();
  });
  
  // Game screen navigation
  elements.backToMenuBtn.addEventListener('click', () => {
    console.log('Back to menu button clicked');
    showScreen('top-screen');
    resetGame();
  });
  
  // Settings screen navigation
  elements.backFromSettingsBtn.addEventListener('click', () => {
    console.log('Back from settings button clicked');
    showScreen('top-screen');
  });
  
  // Game controls
  elements.startGameBtn.addEventListener('click', () => {
    console.log('Start game button clicked');
    startLevel();
  });
  
  elements.nextLevelBtn.addEventListener('click', () => {
    console.log('Next level button clicked');
    nextLevel();
  });
  
  elements.replayBtn.addEventListener('click', () => {
    console.log('Replay button clicked');
    replayLevel();
  });
  
  elements.hintBtn.addEventListener('click', () => {
    console.log('Hint button clicked');
    showHint();
  });
  
  // Settings controls
  elements.volumeSlider.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    currentGameState.settings.volume = volume;
    elements.volumeValue.textContent = e.target.value + '%';
    updateAudioVolume(volume);
    saveSettings();
  });
  
  elements.soundToggle.addEventListener('click', () => {
    currentGameState.settings.soundEnabled = !currentGameState.settings.soundEnabled;
    elements.soundToggle.textContent = currentGameState.settings.soundEnabled ? '„Ç™„É≥' : '„Ç™„Éï';
    elements.soundToggle.classList.toggle('active', currentGameState.settings.soundEnabled);
    saveSettings();
  });
  
  elements.displaySpeed.addEventListener('change', (e) => {
    currentGameState.settings.displaySpeed = e.target.value;
    saveSettings();
  });
  
  elements.resetScoresBtn.addEventListener('click', () => {
    if (confirm('„Çπ„Ç≥„Ç¢„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
      localStorage.removeItem('emojiGameScores');
      alert('„Çπ„Ç≥„Ç¢„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„ÅüÔºÅ');
    }
  });
  
  // Modal controls
  elements.continueBtn.addEventListener('click', () => {
    hideModal();
    nextLevel();
  });
  
  elements.endGameBtn.addEventListener('click', () => {
    hideModal();
    showScreen('top-screen');
    resetGame();
  });
  
  console.log('Event listeners set up successfully');
}

// Screen navigation
function showScreen(screenId) {
  console.log(`Showing screen: ${screenId}`);
  
  // Hide all screens
  document.querySelectorAll('.screen').forEach(screen => {
    screen.classList.remove('active');
  });
  
  // Show target screen
  const targetScreen = document.getElementById(screenId);
  if (targetScreen) {
    targetScreen.classList.add('active');
  } else {
    console.error(`Screen not found: ${screenId}`);
  }
}

// Game initialization
function startGame(mode) {
  console.log(`Starting game in ${mode} mode`);
  
  currentGameState.mode = mode;
  currentGameState.level = 1;
  currentGameState.score = 0;
  currentGameState.sequence = [];
  currentGameState.userSequence = [];
  currentGameState.isPlaying = true;
  currentGameState.combo = 0;
  currentGameState.maxCombo = 0;
  currentGameState.hasMistake = false;
  currentGameState.phase = GamePhases.READY;
  eventBus.emit('phase', currentGameState.phase);
  
  showScreen('game-screen');
  updateGameUI();
  
  // Setup display area based on mode
  if (mode === 'normal') {
    elements.emojiDisplaySingle.classList.remove('hidden');
    elements.emojiDisplayDual.classList.add('hidden');
  } else {
    elements.emojiDisplaySingle.classList.add('hidden');
    elements.emojiDisplayDual.classList.remove('hidden');
  }
  
  // Show start button
  elements.startGameBtn.classList.remove('hidden');
  elements.nextLevelBtn.classList.add('hidden');
  elements.replayBtn.classList.add('hidden');
  elements.choiceArea.classList.add('hidden');
  elements.hintBtn.classList.add('hidden');
  
  updateStatusText('„Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
}

// Start a level
function startLevel() {
  console.log(`Starting level ${currentGameState.level}`);
  
  currentGameState.userSequence = [];
  currentGameState.isDisplaying = true;
  currentGameState.phase = GamePhases.DISPLAYING;
  eventBus.emit('phase', currentGameState.phase);
  
  // Hide controls
  elements.startGameBtn.classList.add('hidden');
  elements.nextLevelBtn.classList.add('hidden');
  elements.replayBtn.classList.add('hidden');
  elements.choiceArea.classList.add('hidden');
  elements.hintBtn.classList.add('hidden');
  
  updateStatusText('„Çà„ÅèË¶ã„Å¶„Å≠ÔºÅ');
  
  // Generate sequence
  generateSequence();
  
  // Start displaying sequence
  setTimeout(() => {
    displaySequence();
  }, 1000);
}

// Generate emoji sequence
function generateSequence() {
  const allEmojis = [
    ...gameData.emojis.animals,
    ...gameData.emojis.foods,
    ...gameData.emojis.toys,
    ...gameData.emojis.vehicles,
    ...gameData.emojis.items
  ];
  
  currentGameState.sequence = [];
  
  if (currentGameState.mode === 'normal') {
    const sequenceLength = gameData.gameSettings.normalMode.startLevel + currentGameState.level - 1;
    for (let i = 0; i < sequenceLength; i++) {
      const randomEmoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
      currentGameState.sequence.push(randomEmoji);
    }
  } else {
    const pairCount = gameData.gameSettings.hardMode.startPairs + currentGameState.level - 1;
    for (let i = 0; i < pairCount; i++) {
      const leftEmoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
      const rightEmoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
      currentGameState.sequence.push({ left: leftEmoji, right: rightEmoji });
    }
  }
  
  console.log('Generated sequence:', currentGameState.sequence);
}

// Display the sequence
function displaySequence() {
  console.log('Displaying sequence...');
  
  const displayDuration = getDisplayDuration();
  let currentIndex = 0;
  
  function showNext() {
    if (currentIndex >= currentGameState.sequence.length) {
      // Sequence complete
      setTimeout(() => {
        currentGameState.isDisplaying = false;
        showChoices();
      }, 500);
      return;
    }
    
    const item = currentGameState.sequence[currentIndex];
    
    if (currentGameState.mode === 'normal') {
      // Single emoji display
      const emojiSquare = elements.emojiDisplaySingle.querySelector('.emoji-square');
      emojiSquare.textContent = item;
      emojiSquare.classList.add('active');
      
      setTimeout(() => {
        emojiSquare.classList.remove('active');
        emojiSquare.textContent = '';
        currentIndex++;
        setTimeout(showNext, 200);
      }, displayDuration);
    } else {
      // Dual emoji display
      const leftSquare = elements.emojiDisplayDual.querySelector('.emoji-square.left');
      const rightSquare = elements.emojiDisplayDual.querySelector('.emoji-square.right');
      
      leftSquare.textContent = item.left;
      rightSquare.textContent = item.right;
      leftSquare.classList.add('active');
      rightSquare.classList.add('active');
      
      setTimeout(() => {
        leftSquare.classList.remove('active');
        rightSquare.classList.remove('active');
        leftSquare.textContent = '';
        rightSquare.textContent = '';
        currentIndex++;
        setTimeout(showNext, 200);
      }, displayDuration);
    }
  }
  
  showNext();
}

// Show choice options
function showChoices() {
  console.log('Showing choices...');

  currentGameState.phase = GamePhases.INPUT;
  eventBus.emit('phase', currentGameState.phase);
  
  updateStatusText('È†ÜÁï™„Å´„Çø„ÉÉ„Éó„Åó„Å¶„Å≠ÔºÅ');
  elements.choiceArea.classList.remove('hidden');
  elements.hintBtn.classList.remove('hidden');
  
  // Generate choice options
  const allEmojis = [
    ...gameData.emojis.animals,
    ...gameData.emojis.foods,
    ...gameData.emojis.toys,
    ...gameData.emojis.vehicles,
    ...gameData.emojis.items
  ];
  
  let choiceOptions = [];
  
  if (currentGameState.mode === 'normal') {
    // Include all sequence emojis
    choiceOptions = [...currentGameState.sequence];
    
    // Add random distractors
    while (choiceOptions.length < Math.min(12, allEmojis.length)) {
      const randomEmoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
      if (!choiceOptions.includes(randomEmoji)) {
        choiceOptions.push(randomEmoji);
      }
    }
  } else {
    // For hard mode, flatten the pairs
    currentGameState.sequence.forEach(pair => {
      if (!choiceOptions.includes(pair.left)) choiceOptions.push(pair.left);
      if (!choiceOptions.includes(pair.right)) choiceOptions.push(pair.right);
    });
    
    // Add random distractors
    while (choiceOptions.length < Math.min(12, allEmojis.length)) {
      const randomEmoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
      if (!choiceOptions.includes(randomEmoji)) {
        choiceOptions.push(randomEmoji);
      }
    }
  }
  
  // Shuffle options
  choiceOptions.sort(() => Math.random() - 0.5);
  
  // Create choice buttons
  elements.choiceGrid.innerHTML = '';
  choiceOptions.forEach(emoji => {
    const button = document.createElement('button');
    button.className = 'choice-item';
    button.textContent = emoji;
    button.addEventListener('click', () => handleChoice(emoji));
    elements.choiceGrid.appendChild(button);
  });
}

// Handle user choice
function handleChoice(emoji) {
  if (currentGameState.isDisplaying) return;
  
  console.log('User chose:', emoji);
  
  const expectedIndex = currentGameState.userSequence.length;
  let isCorrect = false;
  let correctEmoji = '';
  
  if (currentGameState.mode === 'normal') {
    correctEmoji = currentGameState.sequence[expectedIndex];
    isCorrect = correctEmoji === emoji;
  } else {
    // For hard mode, check if the emoji is in the expected position
    const expectedPair = currentGameState.sequence[Math.floor(expectedIndex / 2)];
    if (expectedIndex % 2 === 0) {
      correctEmoji = expectedPair.left;
      isCorrect = expectedPair.left === emoji;
    } else {
      correctEmoji = expectedPair.right;
      isCorrect = expectedPair.right === emoji;
    }
  }
  
  // Find the clicked button
  const clickedButton = Array.from(elements.choiceGrid.children).find(btn => btn.textContent === emoji);
  
  if (isCorrect) {
    clickedButton.classList.add('correct');
    currentGameState.userSequence.push(emoji);
    currentGameState.combo++;
    currentGameState.maxCombo = Math.max(currentGameState.maxCombo, currentGameState.combo);
    
    // „Ç≥„É≥„ÉúË°®Á§∫
    if (currentGameState.combo >= 3) {
      showComboEffect(currentGameState.combo);
    }
    
    playCorrectSound();
    
    // Check if sequence is complete
    const expectedLength = currentGameState.mode === 'normal' 
      ? currentGameState.sequence.length 
      : currentGameState.sequence.length * 2;
    
    if (currentGameState.userSequence.length === expectedLength) {
      // Level complete!
      setTimeout(() => {
        levelComplete();
      }, 1000);
    }
  } else {
    // ‰∏çÊ≠£Ëß£„ÅÆÂ†¥Âêà
    clickedButton.classList.add('incorrect');
    currentGameState.hasMistake = true;
    currentGameState.combo = 0;
    playIncorrectSound();
    
    // Ê≠£Ëß£„Å†„Å£„Åü„ÇÇ„ÅÆ„ÇíË°®Á§∫Ôºà‰∏ÄÁû¨„Å†„ÅëÔºâ
    const correctButton = Array.from(elements.choiceGrid.children).find(btn => btn.textContent === correctEmoji);
    if (correctButton) {
      correctButton.classList.add('show-correct');
      
      // „Äå„Åì„Çå„ÅåÊ≠£Ëß£„Äç„Å®„ÅÑ„ÅÜ„É©„Éô„É´„ÇíË°®Á§∫
      const correctLabel = document.createElement('div');
      correctLabel.className = 'correct-label';
      correctLabel.textContent = '„Åì„Çå„ÅåÊ≠£Ëß£ÔºÅ';
      correctButton.appendChild(correctLabel);
      
      // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
      updateStatusText(`${expectedIndex + 1}Áï™ÁõÆ„ÅØ ${correctEmoji} „Å†„Å£„Åü„Çà`);
    }
    
    // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„É¨„Éô„É´Â§±Êïó„Å∏
    setTimeout(() => {
      levelFailed();
    }, 2000); // 2ÁßíÈñìÊ≠£Ëß£„ÇíË°®Á§∫
  }
}

// Level complete
function levelComplete() {
  console.log('Level complete!');

  currentGameState.phase = GamePhases.RESULT;
  eventBus.emit('phase', currentGameState.phase);
  
  currentGameState.score += currentGameState.level * 10;
  updateGameUI();
  
  // „Éê„ÉÉ„Ç∏„ÉÅ„Çß„ÉÉ„ÇØ
  checkBadges();
  
  showResultModal('üéâ', '„Åõ„ÅÑ„Åã„ÅÑÔºÅ', '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ', true);
}

// Level failed
function levelFailed() {
  console.log('Level failed!');

  currentGameState.phase = GamePhases.RESULT;
  eventBus.emit('phase', currentGameState.phase);
  
  // Ê≠£Ëß£„Ç∑„Éº„Ç±„É≥„Çπ„ÇíË°®Á§∫„Åô„ÇãÂâç„Å´Â∞ë„ÅóÂæÖ„Å§
  setTimeout(() => {
    showCorrectSequence(() => {
      // Ê≠£Ëß£Ë°®Á§∫„ÅåÁµÇ„Çè„Å£„Åü„Çâ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
      showResultModal('üò¢', '„Åñ„Çì„Å≠„Çì...', '„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „Åå„Çì„Å∞„Çç„ÅÜÔºÅ', false);
    });
  }, 1000);
}

// Ê≠£Ëß£„Ç∑„Éº„Ç±„É≥„Çπ„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
function showCorrectSequence(callback) {
  updateStatusText('Ê≠£Ëß£„ÅØ„Åì„Çå„Å†„Å£„Åü„ÇàÔºÅ');
  
  // ÈÅ∏ÊäûËÇ¢„Çí„Åô„Åπ„Å¶ÁÑ°ÂäπÂåñ
  const choiceButtons = elements.choiceGrid.querySelectorAll('.choice-item');
  choiceButtons.forEach(btn => {
    btn.disabled = true;
    btn.classList.remove('selected', 'correct', 'incorrect');
  });
  
  let currentIndex = 0;
  const highlightDelay = 800; // „Éü„É™Áßí
  
  function highlightNext() {
    if (currentGameState.mode === 'normal') {
      // ÈÄöÂ∏∏„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
      if (currentIndex >= currentGameState.sequence.length) {
        if (callback) setTimeout(callback, 500);
        return;
      }
      
      const correctEmoji = currentGameState.sequence[currentIndex];
      const correctButton = Array.from(choiceButtons).find(btn => btn.textContent === correctEmoji);
      
      if (correctButton) {
        // Ê≠£Ëß£„ÅÆÁµµÊñáÂ≠ó„Çí„Éè„Ç§„É©„Ç§„Éà
        correctButton.classList.add('show-correct');
        
        // È†ÜÁï™„ÇíË°®Á§∫
        const orderBadge = document.createElement('span');
        orderBadge.className = 'order-badge';
        orderBadge.textContent = currentIndex + 1;
        correctButton.appendChild(orderBadge);
        
        // Ê¨°„ÅÆ„Éè„Ç§„É©„Ç§„Éà„Å∏
        setTimeout(() => {
          currentIndex++;
          highlightNext();
        }, highlightDelay);
      } else {
        currentIndex++;
        highlightNext();
      }
    } else {
      // „Éè„Éº„Éâ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
      if (currentIndex >= currentGameState.sequence.length * 2) {
        if (callback) setTimeout(callback, 500);
        return;
      }
      
      const pairIndex = Math.floor(currentIndex / 2);
      const isLeft = currentIndex % 2 === 0;
      
      const correctEmoji = isLeft 
        ? currentGameState.sequence[pairIndex].left 
        : currentGameState.sequence[pairIndex].right;
      
      const correctButton = Array.from(choiceButtons).find(btn => btn.textContent === correctEmoji);
      
      if (correctButton) {
        // Ê≠£Ëß£„ÅÆÁµµÊñáÂ≠ó„Çí„Éè„Ç§„É©„Ç§„Éà
        correctButton.classList.add('show-correct');
        
        // È†ÜÁï™„ÇíË°®Á§∫
        const orderBadge = document.createElement('span');
        orderBadge.className = 'order-badge';
        orderBadge.textContent = currentIndex + 1;
        correctButton.appendChild(orderBadge);
        
        // Ê¨°„ÅÆ„Éè„Ç§„É©„Ç§„Éà„Å∏
        setTimeout(() => {
          currentIndex++;
          highlightNext();
        }, highlightDelay);
      } else {
        currentIndex++;
        highlightNext();
      }
    }
  }
  
  // „Éè„Ç§„É©„Ç§„ÉàÈñãÂßã
  highlightNext();
}

// Show result modal
function showResultModal(emoji, title, message, success) {
  elements.resultEmoji.textContent = emoji;
  elements.resultTitle.textContent = title;
  
  // ‰∏çÊ≠£Ëß£„ÅÆÂ†¥Âêà„ÄÅËøΩÂä†ÊÉÖÂ†±„ÇíË°®Á§∫
  if (!success) {
    // Ê≠£Ëß£„ÅÆÈï∑„Åï„Å®ÂÆüÈöõ„Å´Á≠î„Åà„ÅüÈï∑„Åï„ÇíË°®Á§∫
    const answeredCount = currentGameState.userSequence.length;
    const totalCount = currentGameState.mode === 'normal' 
      ? currentGameState.sequence.length 
      : currentGameState.sequence.length * 2;
    
    message += `<div class="result-stats">
      <p>${answeredCount}ÂÄãÊ≠£Ëß£ / ÂÖ®${totalCount}ÂÄã‰∏≠</p>
      <div class="result-progress">
        <div class="result-progress-fill" style="width: ${(answeredCount / totalCount) * 100}%"></div>
      </div>
    </div>`;
    
    // „Äå„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Äç„Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ§âÊõ¥
    elements.endGameBtn.textContent = '„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÊåëÊà¶„Åô„Çã';
  } else {
    elements.endGameBtn.textContent = '„Åä„Çè„Çã';
  }
  
  elements.resultMessage.innerHTML = message;
  
  if (success) {
    elements.continueBtn.classList.remove('hidden');
    elements.resultModal.querySelector('.modal-content').classList.add('success');
    if (currentGameState.level >= 10) {
      elements.continueBtn.textContent = '„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ';
    } else {
      elements.continueBtn.textContent = '„Å§„Åé„ÅÆ„É¨„Éô„É´';
    }
  } else {
    elements.continueBtn.classList.add('hidden');
    elements.resultModal.querySelector('.modal-content').classList.remove('success');
  }
  
  elements.resultModal.classList.remove('hidden');
}

// Hide modal
function hideModal() {
  elements.resultModal.classList.add('hidden');
}

// Next level
function nextLevel() {
  if (currentGameState.level >= 10) {
    // Game complete
    showScreen('top-screen');
    resetGame();
    return;
  }
  
  currentGameState.level++;
  updateGameUI();
  
  elements.startGameBtn.classList.remove('hidden');
  elements.nextLevelBtn.classList.add('hidden');
  elements.replayBtn.classList.add('hidden');
  elements.choiceArea.classList.add('hidden');
  elements.hintBtn.classList.add('hidden');

  updateStatusText('„Å§„Åé„ÅÆ„É¨„Éô„É´ÔºÅ„Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
  currentGameState.phase = GamePhases.READY;
  eventBus.emit('phase', currentGameState.phase);
}

// Replay level
function replayLevel() {
  elements.startGameBtn.classList.remove('hidden');
  elements.nextLevelBtn.classList.add('hidden');
  elements.replayBtn.classList.add('hidden');
  elements.choiceArea.classList.add('hidden');
  elements.hintBtn.classList.add('hidden');

  updateStatusText('„Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
  currentGameState.phase = GamePhases.READY;
  eventBus.emit('phase', currentGameState.phase);
}

// Reset game
function resetGame() {
  currentGameState.mode = null;
  currentGameState.level = 1;
  currentGameState.score = 0;
  currentGameState.sequence = [];
  currentGameState.userSequence = [];
  currentGameState.isPlaying = false;
  currentGameState.isDisplaying = false;
  currentGameState.combo = 0;
  currentGameState.maxCombo = 0;
  currentGameState.hasMistake = false;
  currentGameState.phase = GamePhases.READY;
  eventBus.emit('phase', currentGameState.phase);
}

// Update game UI
function updateGameUI() {
  elements.currentLevel.textContent = `„É¨„Éô„É´ ${currentGameState.level}`;
  elements.currentScore.textContent = `„Çπ„Ç≥„Ç¢: ${currentGameState.score}`;
  
  // „É¨„Éô„É´ÈÄ≤Ë°å„Éê„Éº„ÇíÊõ¥Êñ∞
  const progressPercentage = (currentGameState.level / 10) * 100;
  elements.levelProgress.style.width = `${progressPercentage}%`;
}

// Update status text
function updateStatusText(text) {
  elements.statusText.textContent = text;
}

// Get display duration based on settings
function getDisplayDuration() {
  const baseDuration = currentGameState.mode === 'normal' 
    ? gameData.gameSettings.normalMode.displayDuration
    : gameData.gameSettings.hardMode.displayDuration;
  
  switch (currentGameState.settings.displaySpeed) {
    case 'slow': return baseDuration * 1.5;
    case 'fast': return baseDuration * 0.7;
    default: return baseDuration;
  }
}

// „Éí„É≥„ÉàÊ©üËÉΩ„ÅÆÂÆüË£Ö
function showHint() {
  if (currentGameState.userSequence.length < currentGameState.sequence.length) {
    const nextIndex = currentGameState.userSequence.length;
    const nextEmoji = currentGameState.mode === 'normal' 
      ? currentGameState.sequence[nextIndex]
      : (nextIndex % 2 === 0 
          ? currentGameState.sequence[Math.floor(nextIndex / 2)].left 
          : currentGameState.sequence[Math.floor(nextIndex / 2)].right);
    
    // Ê¨°„Å´ÈÅ∏„Å∂„Åπ„ÅçÁµµÊñáÂ≠ó„Çí‰∏ÄÁû¨ÂÖâ„Çâ„Åõ„Çã
    const buttons = Array.from(elements.choiceGrid.children);
    const hintButton = buttons.find(btn => btn.textContent === nextEmoji);
    
    if (hintButton) {
      hintButton.classList.add('hint-flash');
      setTimeout(() => {
        hintButton.classList.remove('hint-flash');
      }, 500);
    }
    
    // „Éí„É≥„Éà‰ΩøÁî®„Åß„Çπ„Ç≥„Ç¢Ê∏õÂ∞ë
    currentGameState.score = Math.max(0, currentGameState.score - 5);
    updateGameUI();
  }
}

// „Ç≥„É≥„Éú„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫Èñ¢Êï∞
function showComboEffect(combo) {
  const comboDiv = document.createElement('div');
  comboDiv.className = 'combo-effect';
  comboDiv.textContent = `${combo} „Ç≥„É≥„ÉúÔºÅ +${combo}ÁÇπ`;
  
  document.body.appendChild(comboDiv);
  
  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´ÂâäÈô§
  setTimeout(() => {
    comboDiv.classList.add('fade-out');
    setTimeout(() => {
      document.body.removeChild(comboDiv);
    }, 500);
  }, 1000);
  
  // „Ç≥„É≥„Éú„Éú„Éº„Éä„ÇπÂä†ÁÆó
  currentGameState.score += combo;
  updateGameUI();
}

// „Éê„ÉÉ„Ç∏„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
function checkBadges() {
  let newBadges = [];
  
  // „É¨„Éô„É´„ÇØ„É™„Ç¢
  if (!badges[0].unlocked && currentGameState.level > 1) {
    badges[0].unlocked = true;
    newBadges.push(badges[0]);
  }
  
  // „É¨„Éô„É´5Âà∞ÈÅî
  if (!badges[1].unlocked && currentGameState.level >= 5) {
    badges[1].unlocked = true;
    newBadges.push(badges[1]);
  }
  
  // „É¨„Éô„É´10Âà∞ÈÅî
  if (!badges[2].unlocked && currentGameState.level >= 10) {
    badges[2].unlocked = true;
    newBadges.push(badges[2]);
  }
  
  // 10„Ç≥„É≥„ÉúÈÅîÊàê
  if (!badges[3].unlocked && currentGameState.maxCombo >= 10) {
    badges[3].unlocked = true;
    newBadges.push(badges[3]);
  }
  
  // „Éë„Éº„Éï„Çß„ÇØ„Éà
  if (!badges[4].unlocked && currentGameState.level > 1 && !currentGameState.hasMistake) {
    badges[4].unlocked = true;
    newBadges.push(badges[4]);
  }
  
  // Êñ∞„Åó„ÅÑ„Éê„ÉÉ„Ç∏„ÇíÁç≤Âæó„Åó„ÅüÂ†¥Âêà„ÄÅË°®Á§∫
  if (newBadges.length > 0) {
    showBadgeNotification(newBadges);
    saveBadges();
  }
}

// „Éê„ÉÉ„Ç∏ÈÄöÁü•Ë°®Á§∫
function showBadgeNotification(newBadges) {
  const badge = newBadges[0]; // ÊúÄÂàù„ÅÆ„Éê„ÉÉ„Ç∏„ÇíË°®Á§∫
  
  const badgeDiv = document.createElement('div');
  badgeDiv.className = 'badge-notification';
  badgeDiv.innerHTML = `
    <div class="badge-emoji">${badge.emoji}</div>
    <div class="badge-info">
      <h3>„Éê„ÉÉ„Ç∏„Ç≤„ÉÉ„ÉàÔºÅ</h3>
      <p>${badge.name}</p>
      <p class="badge-desc">${badge.description}</p>
    </div>
  `;
  
  document.body.appendChild(badgeDiv);
  
  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´ÂâäÈô§
  setTimeout(() => {
    badgeDiv.classList.add('slide-out');
    setTimeout(() => {
      document.body.removeChild(badgeDiv);
      
      // Ë§áÊï∞„Éê„ÉÉ„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÊ¨°„ÇíË°®Á§∫
      if (newBadges.length > 1) {
        showBadgeNotification(newBadges.slice(1));
      }
    }, 500);
  }, 3000);
}

// „Éê„ÉÉ„Ç∏„Çí‰øùÂ≠ò
function saveBadges() {
  try {
    localStorage.setItem('emojiGameBadges', JSON.stringify(badges));
  } catch (error) {
    console.warn('Error saving badges:', error);
  }
}

// „Éê„ÉÉ„Ç∏„Çí„É≠„Éº„Éâ
function loadBadges() {
  try {
    const savedBadges = localStorage.getItem('emojiGameBadges');
    if (savedBadges) {
      const loadedBadges = JSON.parse(savedBadges);
      badges.forEach((badge, index) => {
        if (loadedBadges[index]) {
          badge.unlocked = loadedBadges[index].unlocked;
        }
      });
    }
  } catch (error) {
    console.warn('Error loading badges:', error);
  }
}

// „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´ÁîªÈù¢„ÅÆÂÆüË£Ö
function showTutorial() {
  const tutorialSteps = [
    {
      title: "„Çà„ÅÜ„Åì„ÅùÔºÅ",
      content: "„Äå„Åß„Å¶„Åç„Åü„ÅÆ„ÄÅ„Å™„Å´Ôºü„Äç„ÅØË®òÊÜ∂Âäõ„ÇíÈçõ„Åà„Çã„Ç≤„Éº„É†„Å†„Çà„ÄÇË°®Á§∫„Åï„Çå„ÇãÁµµÊñáÂ≠ó„ÇíË¶ö„Åà„Å¶„ÄÅÂêå„ÅòÈ†ÜÁï™„Åß„Çø„ÉÉ„Éó„Åó„Å¶„Å≠ÔºÅ",
      emoji: "üëã"
    },
    {
      title: "„Å§„ÅÜ„Åò„Çá„ÅÜ„É¢„Éº„Éâ",
      content: "1„Å§„Åö„Å§ÁµµÊñáÂ≠ó„ÅåË°®Á§∫„Åï„Çå„Çã„Çà„ÄÇ„É¨„Éô„É´„Åå‰∏ä„Åå„Çã„Åî„Å®„Å´Ë¶ö„Åà„ÇãÊï∞„ÅåÂ¢ó„Åà„Å¶„ÅÑ„Åè„ÇàÔºÅ",
      emoji: "üéØ"
    },
    {
      title: "„ÇÄ„Åö„Åã„Åó„ÅÑ„É¢„Éº„Éâ",
      content: "Â∑¶Âè≥„Å´2„Å§„Åö„Å§ÁµµÊñáÂ≠ó„ÅåË°®Á§∫„Åï„Çå„Çã„Çà„ÄÇÂ∑¶„Åã„ÇâÂè≥„ÅÆÈ†ÜÁï™„ÅßË¶ö„Åà„Å¶„Å≠ÔºÅ",
      emoji: "üí™"
    },
    {
      title: "„Ç≥„ÉÑ",
      content: "ÁµµÊñáÂ≠ó„ÇíË®ÄËëâ„ÇÑÁâ©Ë™û„Å´„Åó„Å¶Ë¶ö„Åà„Çã„Å®Ë®òÊÜ∂„Åó„ÇÑ„Åô„ÅÑ„ÇàÔºÅ„Åü„Åè„Åï„ÇìÁ∑¥Áøí„Åó„Å¶Ë®òÊÜ∂Âäõ„Çí„Ç¢„ÉÉ„Éó„Åï„Åõ„Çà„ÅÜÔºÅ",
      emoji: "üí°"
    }
  ];
  
  let currentStep = 0;
  
  // „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´„É¢„Éº„ÉÄ„É´‰ΩúÊàê
  const tutorialModal = document.createElement('div');
  tutorialModal.className = 'modal';
  tutorialModal.id = 'tutorial-modal';
  
  function updateTutorialContent() {
    const step = tutorialSteps[currentStep];
    tutorialModal.innerHTML = `
      <div class="modal-content tutorial">
        <div class="tutorial-progress">
          ${tutorialSteps.map((_, i) => 
            `<div class="progress-dot ${i === currentStep ? 'active' : ''}"></div>`
          ).join('')}
        </div>
        <div class="tutorial-emoji">${step.emoji}</div>
        <h2>${step.title}</h2>
        <p>${step.content}</p>
        <div class="modal-actions">
          ${currentStep > 0 ? '<button id="prev-step" class="btn btn--secondary">„Åæ„Åà„Å∏</button>' : ''}
          ${currentStep < tutorialSteps.length - 1 
            ? '<button id="next-step" class="btn btn--primary">„Å§„Åé„Å∏</button>' 
            : '<button id="finish-tutorial" class="btn btn--primary">„ÅØ„Åò„ÇÅ„Çã</button>'}
        </div>
      </div>
    `;
    
    document.body.appendChild(tutorialModal);
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    if (currentStep > 0) {
      document.getElementById('prev-step').addEventListener('click', () => {
        currentStep--;
        updateTutorialContent();
      });
    }
    
    if (currentStep < tutorialSteps.length - 1) {
      document.getElementById('next-step').addEventListener('click', () => {
        currentStep++;
        updateTutorialContent();
      });
    } else {
      document.getElementById('finish-tutorial').addEventListener('click', () => {
        document.body.removeChild(tutorialModal);
      });
    }
  }
  
  updateTutorialContent();
}

// Audio functions
function initializeAudio() {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    gainNode = audioContext.createGain();
    gainNode.connect(audioContext.destination);
    gainNode.gain.value = currentGameState.settings.volume;
    console.log('Audio initialized successfully');
  } catch (error) {
    console.warn('Audio initialization failed:', error);
  }
}

function updateAudioVolume(volume) {
  if (gainNode) {
    gainNode.gain.value = volume;
  }
}

function playCorrectSound() {
  if (!currentGameState.settings.soundEnabled || !audioContext) return;
  
  try {
    const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
    frequencies.forEach((freq, index) => {
      const oscillator = audioContext.createOscillator();
      const tempGain = audioContext.createGain();
      
      oscillator.connect(tempGain);
      tempGain.connect(gainNode);
      
      oscillator.frequency.value = freq;
      oscillator.type = 'sine';
      
      tempGain.gain.setValueAtTime(0.1, audioContext.currentTime + index * 0.05);
      tempGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.05 + 0.3);
      
      oscillator.start(audioContext.currentTime + index * 0.05);
      oscillator.stop(audioContext.currentTime + index * 0.05 + 0.3);
    });
  } catch (error) {
    console.warn('Error playing correct sound:', error);
  }
}

function playIncorrectSound() {
  if (!currentGameState.settings.soundEnabled || !audioContext) return;
  
  try {
    const oscillator = audioContext.createOscillator();
    const tempGain = audioContext.createGain();
    
    oscillator.connect(tempGain);
    tempGain.connect(gainNode);
    
    oscillator.frequency.value = 130.81; // C3
    oscillator.type = 'sawtooth';
    
    tempGain.gain.setValueAtTime(0.2, audioContext.currentTime);
    tempGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.3);
  } catch (error) {
    console.warn('Error playing incorrect sound:', error);
  }
}

// Settings management
function loadSettings() {
  try {
    const savedSettings = localStorage.getItem('emojiGameSettings');
    if (savedSettings) {
      const settings = JSON.parse(savedSettings);
      currentGameState.settings = { ...currentGameState.settings, ...settings };
    }
    
    // Update UI
    elements.volumeSlider.value = currentGameState.settings.volume * 100;
    elements.volumeValue.textContent = Math.round(currentGameState.settings.volume * 100) + '%';
    elements.soundToggle.textContent = currentGameState.settings.soundEnabled ? '„Ç™„É≥' : '„Ç™„Éï';
    elements.soundToggle.classList.toggle('active', currentGameState.settings.soundEnabled);
    elements.displaySpeed.value = currentGameState.settings.displaySpeed;
    
    if (gainNode) {
      gainNode.gain.value = currentGameState.settings.volume;
    }
    
    // „Éê„ÉÉ„Ç∏„Çí„É≠„Éº„Éâ
    loadBadges();
  } catch (error) {
    console.warn('Error loading settings:', error);
  }
}

function saveSettings() {
  try {
    localStorage.setItem('emojiGameSettings', JSON.stringify(currentGameState.settings));
  } catch (error) {
    console.warn('Error saving settings:', error);
  }
}

// Initialize audio context on user interaction
document.addEventListener('click', function initAudioOnClick() {
  if (audioContext && audioContext.state === 'suspended') {
    audioContext.resume();
  }
}, { once: true });

// Handle visibility change for audio context
  document.addEventListener('visibilitychange', function() {
    if (audioContext) {
      if (document.hidden) {
        audioContext.suspend();
      } else {
        audioContext.resume();
      }
    }
  });

  console.log('App.js loaded successfully');

  return { init: initializeApp };
})();

document.addEventListener('DOMContentLoaded', Game.init);
