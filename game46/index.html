<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f5f5f5;
      color: #333;
      padding-bottom: 40px;
    }

    .header {
      position: sticky;
      top: 0;
      background-color: #fff;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 100;
      position: relative;
    }

    .btn-help {
      position: absolute;
      right: 20px;
      top: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #3498db;
      color: white;
      font-size: 24px;
      font-weight: bold;
      padding: 0;
      min-width: 40px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      z-index: 101;
    }

    .btn-help:hover {
      background-color: #2980b9;
      transform: scale(1.1);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background-color: white;
      border-radius: 12px;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-content h2 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .modal-content h3 {
      color: #3498db;
      margin-top: 24px;
      margin-bottom: 12px;
      font-size: 20px;
    }

    .modal-content h4 {
      color: #2c3e50;
      margin-top: 16px;
      margin-bottom: 8px;
      font-size: 18px;
    }

    .modal-content p, .modal-content li {
      line-height: 1.8;
      margin-bottom: 12px;
      font-size: 15px;
    }

    .modal-content ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .modal-content hr {
      margin: 20px 0;
      border: none;
      border-top: 2px solid #ecf0f1;
    }

    .modal-content strong {
      font-weight: 600;
      color: #2c3e50;
    }

    .btn-close-modal {
      width: 100%;
      margin-top: 24px;
      background-color: #27ae60;
      color: white;
      font-size: 18px;
      padding: 16px;
    }

    .btn-close-modal:hover {
      background-color: #229954;
    }

    .hidden {
      display: none;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 16px;
      text-align: center;
      color: #2c3e50;
    }

    .timer {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: #e74c3c;
      margin-bottom: 16px;
      min-height: 40px;
    }

    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      min-height: 44px;
      min-width: 120px;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-step {
      background-color: #3498db;
      color: white;
    }

    .btn-step:hover:not(:disabled) {
      background-color: #2980b9;
      transform: translateY(-2px);
    }

    .btn-stop {
      background-color: #e74c3c;
      color: white;
    }

    .btn-stop:hover:not(:disabled) {
      background-color: #c0392b;
    }

    .main {
      max-width: 600px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .grid-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px auto;
      max-width: min(90vw, 420px);
      width: 100%;
      overflow: hidden;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 2px;
      background-color: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      margin: 0 auto;
    }

    .grid-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1;
      aspect-ratio: 1;
    }

    .grid-cell.text {
      border-radius: 4px;
      padding: 4px;
    }

    .helper-text {
      margin-top: 12px;
      font-size: 14px;
      color: #7f8c8d;
      text-align: center;
    }

    .input-section {
      background-color: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin: 20px 0;
    }

    .input-section.hidden {
      display: none;
    }

    .input-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="number"] {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      max-width: 200px;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #3498db;
    }

    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 8px;
      min-height: 20px;
    }

    .btn-save {
      background-color: #27ae60;
      color: white;
      width: 100%;
    }

    .btn-save:hover:not(:disabled) {
      background-color: #229954;
    }

    .records-section {
      background-color: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin: 20px 0;
    }

    .records-section h2 {
      font-size: 20px;
      margin-bottom: 16px;
      color: #2c3e50;
    }

    .record-item {
      padding: 16px;
      border-left: 4px solid #3498db;
      background-color: #f8f9fa;
      margin-bottom: 12px;
      border-radius: 4px;
    }

    .record-date {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 4px;
    }

    .record-info {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
    }

    .record-interference {
      font-size: 14px;
      color: #e74c3c;
      margin-top: 4px;
    }

    .btn-export {
      background-color: #9b59b6;
      color: white;
      width: 100%;
      margin-top: 16px;
    }

    .btn-export:hover:not(:disabled) {
      background-color: #8e44ad;
    }

    .empty-records {
      text-align: center;
      color: #95a5a6;
      padding: 40px 20px;
    }

    /* Responsive grid sizes - portrait and landscape */
    /* Base mobile portrait (< 480px) */
    @media (max-width: 479px) and (orientation: portrait) {
      .grid-container {
        max-width: min(90vw, 420px);
      }
      .grid {
        padding: 16px;
      }
      .grid-cell {
        font-size: 14px;
      }
    }

    /* Tablet portrait (480px - 768px) */
    @media (min-width: 480px) and (max-width: 767px) and (orientation: portrait) {
      .grid-container {
        max-width: min(85vw, 500px);
      }
      .grid {
        padding: 20px;
      }
      .grid-cell {
        font-size: 16px;
      }
    }

    /* Desktop portrait (>= 768px) */
    @media (min-width: 768px) and (orientation: portrait) {
      .grid-container {
        max-width: 540px;
      }
      .grid {
        padding: 20px;
      }
      .grid-cell {
        font-size: 16px;
      }
    }

    /* Landscape mode - all sizes */
    @media (orientation: landscape) {
      .grid-container {
        max-width: min(65vw, 700px);
      }
      .grid {
        padding: 20px;
      }
      .grid-cell {
        font-size: 16px;
      }
    }

    /* Landscape with larger screens */
    @media (min-width: 768px) and (orientation: landscape) {
      .grid-container {
        max-width: 700px;
      }
      .grid-cell {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <button class="btn-help" onclick="openHelp()" title="ä½¿ã„æ–¹ã‚’è¦‹ã‚‹">?</button>
    <h1>ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ</h1>
    <div class="timer" id="timer"></div>
    <div class="controls">
      <button class="btn-step" id="btnStep1" onclick="startTest(1)">â–¶ Step 1</button>
      <button class="btn-step" id="btnStep2" onclick="startTest(2)">â–¶ Step 2</button>
      <button class="btn-stop" id="btnStop" onclick="stopTest()" disabled>â–  åœæ­¢</button>
    </div>
  </header>

  <main class="main">
    <div class="grid-container" id="gridContainer"></div>

    <div class="input-section hidden" id="inputSection">
      <div class="input-group">
        <label for="scoreInput">æ­£ç­”æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</label>
        <div class="input-wrapper">
          <input type="number" id="scoreInput" min="0" max="100" placeholder="0">
          <span>å€‹</span>
        </div>
        <div class="error-message" id="errorMessage"></div>
      </div>
      <button class="btn-save" id="btnSave" onclick="saveRecord()">ğŸ’¾ è¨˜éŒ²ã™ã‚‹</button>
    </div>

    <div class="records-section">
      <h2>éå»ã®è¨˜éŒ²</h2>
      <div id="recordsList"></div>
      <button class="btn-export" onclick="exportCSV()">â¬‡ï¸ CSVå‡ºåŠ›</button>
    </div>
  </main>

  <!-- Help Modal -->
  <div id="helpModal" class="modal-overlay hidden" onclick="closeHelpIfClickedOutside(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h2>ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ</h2>
      <p style="font-size: 18px; color: #7f8c8d; margin-bottom: 20px;">éŠã³ãªãŒã‚‰è„³ã‚’é›ãˆã‚ˆã†ï¼</p>
      
      <h3>ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆã¨ã¯ï¼Ÿ</h3>
      <p>è‰²ã‚’èª­ã‚€ã“ã¨ã§è„³ã®<strong>ã€ŒæŠ‘åˆ¶åŠ›ã€</strong>ã‚’æ¸¬å®šã™ã‚‹å¿ƒç†ãƒ†ã‚¹ãƒˆã§ã™ã€‚</p>
      <p><strong>æŠ‘åˆ¶åŠ›</strong>ã¨ã¯ã€é–“é•ã£ãŸç­”ãˆã‚’æˆ‘æ…¢ã—ã¦ã€æ­£ã—ã„ç­”ãˆã‚’é¸ã¶åŠ›ã®ã“ã¨ã€‚ã“ã®åŠ›ãŒå¼·ã„ã»ã©ã€é›†ä¸­åŠ›ã‚„è‡ªåˆ¶å¿ƒãŒé«˜ã„ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚</p>
      
      <hr>
      
      <h3>éŠã³æ–¹</h3>
      
      <h4>Step 1: è‰²ã®ä¸¸ã‚’èª­ã‚‚ã†</h4>
      <ul>
        <li>ã€Œâ–¶ Step 1ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
        <li>ç”»é¢ã«è‰²ã®ã¤ã„ãŸä¸¸ãŒ100å€‹è¡¨ç¤ºã•ã‚Œã¾ã™</li>
        <li><strong>å·¦ä¸Šã‹ã‚‰å³ä¸‹ã¸é †ç•ªã«</strong>ã€ä¸¸ã®è‰²ã‚’å£°ã«å‡ºã—ã¦èª­ã¿ã¾ã™</li>
        <li>20ç§’é–“ã§ã§ãã‚‹ã ã‘ãŸãã•ã‚“èª­ã¿ã¾ã™</li>
        <li>ä¿è­·è€…ã®æ–¹ãŒæ­£ã—ãèª­ã‚ãŸæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</li>
      </ul>
      
      <h4>Step 2: æ–‡å­—ã®è‰²ã‚’èª­ã‚‚ã†</h4>
      <ul>
        <li>ã€Œâ–¶ Step 2ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
        <li>ç”»é¢ã«è‰²ã®åå‰ã®æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
        <li><strong>æ–‡å­—ã®æ„å‘³ã§ã¯ãªãã€æ–‡å­—ã®è‰²</strong>ã‚’å£°ã«å‡ºã—ã¦èª­ã¿ã¾ã™</li>
        <li>ä¾‹:ã€Œã‚ã‹ã€ã¨ã„ã†æ–‡å­—ãŒé’è‰²ãªã‚‰ â†’ã€Œã‚ãŠã€ã¨èª­ã‚€</li>
        <li>20ç§’é–“ã§ã§ãã‚‹ã ã‘ãŸãã•ã‚“èª­ã¿ã¾ã™</li>
      </ul>
      
      <hr>
      
      <h3>ã“ã®ãƒ†ã‚¹ãƒˆã§ä½•ãŒã‚ã‹ã‚‹ã®ï¼Ÿ</h3>
      <p><strong>Step 1ã®çµæœ</strong> â†’ ç´”ç²‹ãªè‰²ã®èªè­˜ã‚¹ãƒ”ãƒ¼ãƒ‰</p>
      <p><strong>Step 2ã®çµæœ</strong> â†’ é–“é•ã£ãŸç­”ãˆã‚’æˆ‘æ…¢ã—ã¦æ­£ã—ã„ç­”ãˆã‚’é¸ã¶åŠ›</p>
      <p><strong>å¹²æ¸‰åº¦</strong> â†’ Step 1ã¨Step 2ã‹ã‚‰è¨ˆç®—ã•ã‚Œã‚‹æ•°å€¤ã€‚ä½ã„ã»ã©æŠ‘åˆ¶åŠ›ãŒé«˜ã„</p>
      
      <hr>
      
      <h3>ã†ã¾ãèª­ã‚€ã‚³ãƒ„</h3>
      <ul>
        <li>âœ… ç„¦ã‚‰ãšã€ä¸€ã¤ãšã¤ç¢ºå®Ÿã«</li>
        <li>âœ… èª­ã¿é–“é•ãˆãŸã‚‰ã€ã™ãã«æ¬¡ã¸</li>
        <li>âœ… Step 2ã§ã¯ã€Œæ–‡å­—ã‚’èª­ã¾ãªã„ã€ã“ã¨ã‚’æ„è­˜</li>
        <li>âœ… æ¯æ—¥ç·´ç¿’ã™ã‚‹ã¨ä¸Šé”ã—ã¾ã™ï¼</li>
      </ul>
      
      <hr>
      
      <h3>ä¿è­·è€…ã®æ–¹ã¸</h3>
      <ul>
        <li>çµæœã‚’æ¯”è¼ƒã™ã‚‹ã®ã§ã¯ãªãã€æˆé•·ã‚’è¦‹å®ˆã‚Šã¾ã—ã‚‡ã†</li>
        <li>æ¥½ã—ãã§ãã‚‹ã“ã¨ãŒä¸€ç•ªå¤§åˆ‡ã§ã™</li>
        <li>ãŠå­æ§˜ã®ãƒšãƒ¼ã‚¹ã§ç„¡ç†ãªã</li>
        <li>è¨˜éŒ²ã‚’æ®‹ã™ã¨ã€æˆé•·ãŒã‚ã‹ã£ã¦ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ï¼</li>
      </ul>
      
      <hr>
      
      <h3>å¯¾è±¡å¹´é½¢</h3>
      <p><strong>ãŠã™ã™ã‚: å°å­¦ç”Ÿä»¥ä¸Š</strong></p>
      <ul>
        <li>ã²ã‚‰ãŒãªãŒèª­ã‚ã‚‹ãŠå­æ§˜</li>
        <li>è‰²ã®åå‰ãŒã‚ã‹ã‚‹ãŠå­æ§˜</li>
      </ul>
      
      <hr>
      
      <h3>ã”æ³¨æ„</h3>
      <p>ã“ã®ãƒ†ã‚¹ãƒˆã¯éŠã³ã‚„å­¦ç¿’ç›®çš„ã®ã‚‚ã®ã§ã™ã€‚åŒ»ç™‚è¨ºæ–­ç›®çš„ã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
      
      <button class="btn-close-modal" onclick="closeHelp()">ã‚ã‹ã£ãŸï¼å§‹ã‚ã‚‹</button>
    </div>
  </div>

  <script>
    // Color definitions
    const COLORS = {
      red: { hex: '#E74C3C', name: 'ã‚ã‹' },
      blue: { hex: '#3498DB', name: 'ã‚ãŠ' },
      yellow: { hex: '#F39C12', name: 'ãã„ã‚' },
      green: { hex: '#27AE60', name: 'ã¿ã©ã‚Š' }
    };

    const COLOR_ARRAY = ['#E74C3C', '#3498DB', '#F39C12', '#27AE60'];
    const TEXT_ARRAY = ['ã‚ã‹', 'ã‚ãŠ', 'ãã„ã‚', 'ã¿ã©ã‚Š'];
    
    const TEXT_COLOR_MAP = {
      'ã‚ã‹': ['#3498DB', '#F39C12', '#27AE60'],
      'ã‚ãŠ': ['#E74C3C', '#F39C12', '#27AE60'],
      'ãã„ã‚': ['#E74C3C', '#3498DB', '#27AE60'],
      'ã¿ã©ã‚Š': ['#E74C3C', '#3498DB', '#F39C12']
    };

    const TEST_DURATION = 20;
    const GRID_SIZE = 10;

    // State management
    let state = {
      status: 'idle', // idle, running, finished
      currentStep: null,
      currentSessionId: null,
      timeRemaining: TEST_DURATION,
      timerInterval: null
    };

    // UUID v4 generator
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Get random element from array
    function randomChoice(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    // Calculate cell size based on container
    function calculateCellSize() {
      const gridContainer = document.querySelector('.grid-container');
      if (!gridContainer) return 36;
      
      const containerWidth = gridContainer.clientWidth;
      const padding = 32; // Left + right padding (16px * 2)
      const gapSize = 2;
      const numGaps = 9; // 10 columns = 9 gaps
      const totalGapWidth = numGaps * gapSize;
      const availableWidth = containerWidth - padding - totalGapWidth;
      const cellSize = Math.floor(availableWidth / 10);
      
      // Clamp between reasonable min/max
      return Math.max(28, Math.min(cellSize, 70));
    }

    // Get font size based on orientation and screen size
    function getFontSize() {
      const isLandscape = window.innerWidth > window.innerHeight;
      const width = window.innerWidth;
      
      if (isLandscape) {
        return width > 768 ? 16 : 14;
      } else {
        if (width < 480) return 12;
        if (width < 768) return 13;
        return 14;
      }
    }

    // Generate Step 1 grid (colored dots)
    function generateStep1Grid() {
      const grid = document.createElement('div');
      grid.className = 'grid';
      const cellSize = calculateCellSize();
      const circleSize = Math.floor(cellSize * 0.85);
      
      for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.width = cellSize + 'px';
        cell.style.height = cellSize + 'px';
        
        // Create circle inside cell
        const circle = document.createElement('div');
        circle.style.width = circleSize + 'px';
        circle.style.height = circleSize + 'px';
        circle.style.borderRadius = '50%';
        const color = randomChoice(COLOR_ARRAY);
        circle.style.backgroundColor = color;
        
        cell.appendChild(circle);
        grid.appendChild(cell);
      }
      
      return grid;
    }

    // Generate Step 2 grid (color words with mismatched colors)
    function generateStep2Grid() {
      const grid = document.createElement('div');
      grid.className = 'grid';
      const cellSize = calculateCellSize();
      const fontSize = getFontSize();
      
      for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell text';
        cell.style.width = cellSize + 'px';
        cell.style.height = cellSize + 'px';
        cell.style.fontSize = fontSize + 'px';
        
        const text = randomChoice(TEXT_ARRAY);
        const allowedColors = TEXT_COLOR_MAP[text];
        const color = randomChoice(allowedColors);
        cell.textContent = text;
        cell.style.color = color;
        grid.appendChild(cell);
      }
      
      return grid;
    }

    // Start test
    function startTest(step) {
      // Generate or reuse sessionId
      if (step === 1) {
        state.currentSessionId = generateUUID();
        saveCurrentSessionId(state.currentSessionId);
      } else if (step === 2) {
        // Check if there's a recent Step 1 record (within 5 minutes)
        const savedSessionId = getCurrentSessionId();
        const recentStep1 = findRecentStep1(savedSessionId);
        if (recentStep1) {
          state.currentSessionId = savedSessionId;
        } else {
          state.currentSessionId = generateUUID();
          saveCurrentSessionId(state.currentSessionId);
        }
      }

      state.status = 'running';
      state.currentStep = step;
      state.timeRemaining = TEST_DURATION;

      // Update UI
      document.getElementById('btnStep1').disabled = true;
      document.getElementById('btnStep2').disabled = true;
      document.getElementById('btnStop').disabled = false;
      document.getElementById('inputSection').classList.add('hidden');
      document.getElementById('scoreInput').value = '';
      document.getElementById('errorMessage').textContent = '';

      // Generate grid
      const container = document.getElementById('gridContainer');
      container.innerHTML = '';
      
      // Wait for next frame to ensure container width is calculated
      requestAnimationFrame(() => {
        const grid = step === 1 ? generateStep1Grid() : generateStep2Grid();
        container.appendChild(grid);
      });
      
      const helperText = document.createElement('div');
      helperText.className = 'helper-text';
      helperText.textContent = 'â€»å·¦ä¸Šã‹ã‚‰å³ä¸‹ã¸é †ã«èª­ã¿ã¾ã™';
      container.appendChild(helperText);

      // Start timer
      updateTimerDisplay();
      state.timerInterval = setInterval(() => {
        state.timeRemaining -= 0.1;
        if (state.timeRemaining <= 0) {
          state.timeRemaining = 0;
          stopTest();
        }
        updateTimerDisplay();
      }, 100);
    }

    // Stop test
    function stopTest() {
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }

      state.status = 'finished';
      state.timeRemaining = 0;
      updateTimerDisplay();

      // Update UI
      document.getElementById('btnStep1').disabled = false;
      document.getElementById('btnStep2').disabled = false;
      document.getElementById('btnStop').disabled = true;
      document.getElementById('inputSection').classList.remove('hidden');
      document.getElementById('scoreInput').focus();
    }

    // Update timer display
    function updateTimerDisplay() {
      const timerEl = document.getElementById('timer');
      if (state.status === 'running' || state.status === 'finished') {
        timerEl.textContent = `æ®‹ã‚Šæ™‚é–“: ${state.timeRemaining.toFixed(1)}ç§’`;
      } else {
        timerEl.textContent = '';
      }
    }

    // Validate score input
    function validateScore(value) {
      const errorEl = document.getElementById('errorMessage');
      
      if (value === '' || value === null) {
        errorEl.textContent = 'æ­£ç­”æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        return false;
      }
      
      const num = parseInt(value, 10);
      if (isNaN(num)) {
        errorEl.textContent = 'æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        return false;
      }
      
      if (num < 0 || num > 100) {
        errorEl.textContent = '0ã€œ100ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
        return false;
      }
      
      errorEl.textContent = '';
      return true;
    }

    // Save record
    function saveRecord() {
      const scoreInput = document.getElementById('scoreInput');
      const score = scoreInput.value;

      if (!validateScore(score)) {
        return;
      }

      const numScore = parseInt(score, 10);
      
      // Calculate interference if Step 2
      let interference = null;
      if (state.currentStep === 2) {
        const step1Record = findStep1InSession(state.currentSessionId);
        if (step1Record) {
          interference = 1 - (numScore / step1Record.score);
        }
      }

      // Create record
      const record = {
        ts: new Date().toISOString(),
        step: state.currentStep,
        score: numScore,
        sessionId: state.currentSessionId,
        interference: interference
      };

      // Save to localStorage
      saveRecordToStorage(record);

      // Reset state
      state.status = 'idle';
      state.currentStep = null;
      state.timeRemaining = TEST_DURATION;

      // Clear grid
      document.getElementById('gridContainer').innerHTML = '';
      document.getElementById('inputSection').classList.add('hidden');
      document.getElementById('scoreInput').value = '';
      updateTimerDisplay();

      // Refresh records list
      displayRecords();
    }

    // Storage
    const STORAGE_KEYS = {
      records: 'stroopTestRecords',
      session: 'stroopTestCurrentSessionId'
    };

    let stroopTestRecords = [];
    let currentSessionId = null;
    let helpModalSeen = false;

    function loadRecordsFromStorage() {
      try {
        const stored = localStorage.getItem(STORAGE_KEYS.records);
        if (!stored) return [];
        const parsed = JSON.parse(stored);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error('Failed to load records', e);
        return [];
      }
    }

    function persistRecords() {
      localStorage.setItem(STORAGE_KEYS.records, JSON.stringify(stroopTestRecords));
    }

    function saveRecordToStorage(record) {
      stroopTestRecords = [record, ...stroopTestRecords];
      persistRecords();
    }

    function getRecords() {
      return stroopTestRecords;
    }

    function saveCurrentSessionId(sessionId) {
      currentSessionId = sessionId;
      localStorage.setItem(STORAGE_KEYS.session, sessionId);
    }

    function getCurrentSessionId() {
      if (currentSessionId) return currentSessionId;

      const stored = localStorage.getItem(STORAGE_KEYS.session);
      currentSessionId = stored;
      return stored;
    }

    function findStep1InSession(sessionId) {
      const records = getRecords();
      return records.find(r => r.sessionId === sessionId && r.step === 1);
    }

    function findRecentStep1(sessionId) {
      if (!sessionId) return null;
      
      const records = getRecords();
      const step1 = records.find(r => r.sessionId === sessionId && r.step === 1);
      
      if (!step1) return null;
      
      // Check if within 5 minutes
      const recordTime = new Date(step1.ts).getTime();
      const now = Date.now();
      const fiveMinutes = 5 * 60 * 1000;
      
      return (now - recordTime) <= fiveMinutes ? step1 : null;
    }

    // Display records
    function displayRecords() {
      const records = getRecords();
      const listEl = document.getElementById('recordsList');
      
      if (records.length === 0) {
        listEl.innerHTML = '<div class="empty-records">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      listEl.innerHTML = records.map(record => {
        const date = new Date(record.ts);
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        let html = `
          <div class="record-item">
            <div class="record-date">${dateStr}</div>
            <div class="record-info">Step ${record.step}: ${record.score}å€‹</div>
        `;
        
        if (record.interference !== null) {
          const interferencePercent = Math.round(record.interference * 100);
          html += `<div class="record-interference">å¹²æ¸‰åº¦: ${interferencePercent}%</div>`;
        }
        
        html += '</div>';
        return html;
      }).join('');
    }

    // Export CSV
    function exportCSV() {
      const records = getRecords();
      
      if (records.length === 0) {
        alert('å‡ºåŠ›ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      // Create CSV content with BOM for Excel
      const BOM = '\uFEFF';
      let csv = BOM + 'æ—¥æ™‚,ã‚¹ãƒ†ãƒƒãƒ—,æ­£ç­”æ•°,å¹²æ¸‰åº¦\n';
      
      records.forEach(record => {
        const date = new Date(record.ts);
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        const interference = record.interference !== null ? `${Math.round(record.interference * 100)}%` : '';
        csv += `${dateStr},${record.step},${record.score},${interference}\n`;
      });

      // Create download link
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      const now = new Date();
      const filename = `stroop_test_è¨˜éŒ²_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Input validation on change
    document.getElementById('scoreInput').addEventListener('input', function(e) {
      validateScore(e.target.value);
    });

    // Handle window resize to recalculate sizes if test is running
    let resizeTimeout;
    window.addEventListener('resize', () => {
      if (state.status === 'running' && state.currentStep) {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const container = document.getElementById('gridContainer');
          const helperText = container.querySelector('.helper-text');
          const helperTextContent = helperText ? helperText.textContent : '';
          container.innerHTML = '';
          
          const grid = state.currentStep === 1 ? generateStep1Grid() : generateStep2Grid();
          container.appendChild(grid);
          
          if (helperTextContent) {
            const newHelperText = document.createElement('div');
            newHelperText.className = 'helper-text';
            newHelperText.textContent = helperTextContent;
            container.appendChild(newHelperText);
          }
        }, 200);
      }
    });

    // Help modal functions
    function openHelp() {
      document.getElementById('helpModal').classList.remove('hidden');
    }

    function closeHelp() {
      document.getElementById('helpModal').classList.add('hidden');
      helpModalSeen = true;
    }

    function closeHelpIfClickedOutside(event) {
      if (event.target.id === 'helpModal') {
        closeHelp();
      }
    }

    // Initialize app
    window.addEventListener('DOMContentLoaded', () => {
      stroopTestRecords = loadRecordsFromStorage();
      currentSessionId = getCurrentSessionId();
      displayRecords();

      // Show help modal on first visit (in this session)
      if (!helpModalSeen) {
        openHelp();
      }
    });
  </script>
</body>
</html>